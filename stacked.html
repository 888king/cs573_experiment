<!DOCTYPE html>

<head>
	<meta charset="utf-8">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
	<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
</head>

<body>
	<div class = "col-md-offset-2">
		<h3 id="ChartName">Stackedbar Chart</h3>
	</div>
	<div id="stacked">
	</div>
	<div class = "container">
		<div class="row">
			<div class="col-md-4">
				<div class="input-group">
					<input type="text" id="result" placeholder="ratio">
				</div>
			</div>
			<div class="col-md-2">
				<button onclick="submitFunction()" class="btn btn-primary">Next</button>
			</div>
		</div>
	</div>
	<script type="text/javascript">
			var margin = {top: 40, right: 20, bottom: 40, left: 40};
			var width = 600 - margin.left - margin.right;
			var height = 300 - margin.top - margin.bottom;
			
			var xAxis = d3.scaleBand().range ([0, width]).padding(0.75);

			var yAxis = d3.scaleLinear().range([height, 0]);

			var svg = d3.select("#stacked").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var true_value = 0;
			var input_value = 0;

			d3.csv("points2.csv", function(error, data){
				if(error){
					throw error;
				}

				var index1 = Math.floor(Math.random() * 9);
				var index2 = Math.floor(Math.random() * 9);
				while(index2 == index1)
					index2 = Math.floor(Math.random() * 9);

				if(Number(data[0]["value" + index1]) > Number(data[0]["value" + index2])){
					true_value = Number(data[0]["value" + index2]) / Number(data[0]["value" + index1]) * 100;
				}
				else{
					true_value = Number(data[0]["value" + index1]) / Number(data[0]["value" + index2]) * 100;
				}

				console.log(data[0]["value" + index1]);
				console.log(data[0]["value" + index2]);
				console.log(true_value);

				xAxis.domain(data.map(function(d) { return 1; }));
				yAxis.domain([0, 320]);

				svg.append("g")
					.attr("transform", "translate(" + 0 + "," + height + ")")
					.call(d3.axisBottom(xAxis).tickFormat((domainn,number)=>{return ""}));

				svg.append("g")
					.call(d3.axisLeft(yAxis).tickFormat((domainn,number)=>{return ""}));

				var subgroups = data.columns.slice(1);
				var stackedData = d3.stack().keys(subgroups)(data);
				var data2 = [stackedData[index1][0], stackedData[index2][0]];

				svg.append("g")
					.selectAll("g")
					.data(stackedData)
					.enter().append("g")
					.selectAll("rect")
					.data(function(d) { return d; })
					.enter().append("rect")
					.attr("x", function(d){ return xAxis(1)})
					.attr("y", function(d){ return yAxis(d[1]); })
					.attr("height", function(d){ return yAxis(d[0])-yAxis(d[1]); })
					.attr("width", xAxis.bandwidth())
					.attr("stroke", "black")
					.style("fill", "white");

				svg.append("g")
					.selectAll("circle")
					.data(data2)
					.enter().append("circle")
					.attr("cx", function(d) { return xAxis(1) + 0.5 * xAxis.bandwidth(); })
					.attr("cy", function(d) { return yAxis(0.5 * (d[0] + d[1])); })
					.attr("r", 3)
					.style("fill", "black");
			})
			function submitFunction(){
				var name = escape("Jack")
				var Chart = escape(document.getElementById("ChartName").innerHTML);
				input_value = document.getElementById("result").value;
				window.location.href = "http://localhost:8000/bar.html?name=" + name + "&Chart1=" + Chart + "&input1=" + escape(input_value) + "&true1=" + escape(true_value);
			}
		</script>
</body>